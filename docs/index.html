<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pure Data Effect Demo with Parameters</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ğŸš Pure Data WebAudio Effect Demo</h1>
    <p>Control Pd patch parameters from the browser.</p>
  </header>

  <main class="gallery">
    <div class="card">
      <h2>Delay Effect</h2>
      <p>Apply Pd-built hvcc WebAudio delay effect to a sample sound.</p>

      <audio id="inputAudio" src="audio/input.wav" preload="auto" controls></audio>

      <div class="buttons">
        <button onclick="playEffect()">â–¶ï¸ Play</button>
        <button onclick="stopEffect()">â¹ Stop</button>
      </div>

      <div class="params">
        <label>
          Delay Time (ms): 
          <input type="range" id="delay_time" min="10" max="1000" step="1" value="200"
            oninput="updateParam('delay_time', this.value)">
          <span id="val_delay_time">200</span>
        </label>
        <label>
          Feedback: 
          <input type="range" id="feedback" min="0" max="1" step="0.01" value="0.5"
            oninput="updateParam('feedback', this.value)">
          <span id="val_feedback">0.5</span>
        </label>
      </div>
    </div>
  </main>

  <footer>
    <p>Created by boochow instruments Â· Powered by hvcc WebAudio</p>
  </footer>

  <script type="module">
    import { HvWebAudio } from "./demos/delay_fx.js";

    let ctx = null;
    let hv = null;
    let source = null;

    // Pdãƒ‘ãƒƒãƒå†ç”Ÿ
    async function playEffect() {
      stopEffect();

      ctx = new (window.AudioContext || window.webkitAudioContext)();
      hv = await HvWebAudio.new(ctx);

      // å…¥åŠ›WAVã‚’ãƒ­ãƒ¼ãƒ‰
      const response = await fetch("audio/input.wav");
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await ctx.decodeAudioData(arrayBuffer);

      // ã‚½ãƒ¼ã‚¹â†’hvccå…¥åŠ›â†’ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼å‡ºåŠ›
      source = ctx.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(hv.input);
      hv.output.connect(ctx.destination);
      source.start();

      // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ€å€¤ã‚’åˆæœŸé€ä¿¡
      updateParam("delay_time", document.getElementById("delay_time").value);
      updateParam("feedback", document.getElementById("feedback").value);

      source.onended = () => stopEffect();
      console.log("â–¶ï¸ Effect playback started");
    }

    // ãƒ‘ãƒƒãƒåœæ­¢
    function stopEffect() {
      if (source) { try { source.stop(); } catch(e){} source = null; }
      if (hv) { hv.release(); hv = null; }
      if (ctx) { ctx.close(); ctx = null; }
      console.log("â¹ Stopped");
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€å¤‰æ›´æ™‚ã«Pdãƒ‘ãƒƒãƒã¸é€ä¿¡
    function updateParam(name, val) {
      document.getElementById(`val_${name}`).innerText = val;
      if (hv) {
        hv.sendFloatToReceiver(name, parseFloat(val));
        console.log(`sendFloatToReceiver(${name}, ${val})`);
      }
    }
  </script>
</body>
</html>
